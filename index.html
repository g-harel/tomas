<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOMAS</title>

    <style>
        html,
        body {
            align-items: center;
            display: flex;
            flex-direction: column;
            margin: 0;
            width: 100%;
        }

        body {
            align-self: stretch;
            background-color: #f4ffdf;
            background-image: radial-gradient(#eeeeee 0.95px, transparent 0.95px), radial-gradient(#eeeeee 0.95px, #ffffff 0.95px);
            background-size: 38px 38px;
            background-position: 0 0, 19px 19px;
            font-size: 20px;
            font-family: Helvetica, Arial, sans-serif;
            font-weight: 600;
        }

        .highlight {
            color: #FFA028;
        }

        header {
            align-self: stretch;
            background-color: #000000;
            color: #ffffff;
            font-size: 0.7em;
            font-weight: 700;
            padding: 6px calc(50% - 300px);
        }

        @media only screen and (max-width: 600px) {
            header {
                padding-left: 1rem;
                padding-right: 1rem;
            }
        }

        h1 {
            font-weight: 800;
            font-size: 2.5rem;
            font-family: Helvetica, Arial, sans-serif;
            margin: 26px;
            transform: scaleX(0.95) skewY(-6deg);
        }

        .content {
            max-width: 600px;
            overflow-x: hidden;
            padding: 10px;
            width: calc(100% - 20px);
        }

        form {
            border-radius: 2px;
            display: flex;
            flex-direction: column;
        }

        form input[type="text"] {
            background-color: #ffffff;
            border: 2px solid #8a8a8a;
            border-radius: 3px;
            flex-grow: 1;
            font-family: Helvetica, Arial, sans-serif;
            font-size: 1.1rem;
            text-transform: uppercase;
            padding: 1rem;
        }

        form input[type="text"]::placeholder {
            text-transform: none;
        }

        form .instructions {
            font-weight: normal;
            font-size: 0.7em;
            text-align: center;
            padding: 10px 15%;
        }
    </style>
</head>

<body>
    <header>Buy and hold</header>
    <h1>TOMAS</h1>
    <div class="content">
        <form id="form" action="#">
            <input id="query" type="text" autofocus>
            <span class="instructions">
                Enter your investment strategy to create the perfect portfolio using proprietary advanced AI and the
                blockchain.
            </span>
        </form>
        <div id="container"></div>

        <!-- Components used in the container. -->
        <div hidden>
            <style>
                #loading {
                    text-align: center;
                    padding: 5rem;
                }

                #loading .spinner {
                    animation: spin 1s linear infinite;
                    border: 7px solid transparent;
                    border-top: 7px solid #000000;
                    border-bottom: 7px solid #000000;
                    border-radius: 50%;
                    display: inline-block;
                    height: 20px;
                    width: 20px;
                    margin: 0;
                }

                @keyframes spin {
                    0% {
                        transform: rotate(0deg);
                    }

                    100% {
                        transform: rotate(360deg);
                    }
                }
            </style>
            <div id="loading">
                <div class="spinner"></div>
            </div>

            <style>
                #stock-item {
                    margin-top: 30px;
                    padding: 1rem;
                }

                #stock-item .ticker {
                    min-width: 3em;
                    padding: 0.3em;
                    background-color: #cccccc;
                    border-radius: 0.25em;
                    display: inline-block;
                    text-align: center;
                    font-size: 0.7em;
                    transform: translateY(-0.16em);
                }
            </style>
            <div id="stock-item">
                <span class="ticker">$ticker</span>
                <span class="name">$name</span>
                <span class="allocation">$allocation%</span>
            </div>
        </div>
    </div>

    <!-- Utils -->
    <script>
        // Seeded random number generator.
        // https://stackoverflow.com/a/47593316/3053361
        const rand = (seed) => {
            const xfnv1a = (str) => {
                let h = 2166136261 >>> 0;
                for (let i = 0; i < str.length; i++) {
                    h = Math.imul(h ^ str.charCodeAt(i), 16777619);
                }
                return () => {
                    h += h << 13;
                    h ^= h >>> 7;
                    h += h << 3;
                    h ^= h >>> 17;
                    return (h += h << 5) >>> 0;
                };
            };

            const sfc32 = (a, b, c, d) => () => {
                a >>>= 0;
                b >>>= 0;
                c >>>= 0;
                d >>>= 0;
                var t = (a + b) | 0;
                a = b ^ (b >>> 9);
                b = (c + (c << 3)) | 0;
                c = (c << 21) | (c >>> 11);
                d = (d + 1) | 0;
                t = (t + d) | 0;
                c = (c + t) | 0;
                return (t >>> 0) / 4294967296;
            };

            const seedGenerator = xfnv1a(seed);
            return sfc32(seedGenerator(), seedGenerator(), seedGenerator(), seedGenerator());
        };
    </script>

    <script>
        const container = document.getElementById("container");
        const form = document.getElementById("form");
        const query = document.getElementById("query");

        // Components
        const loadingComponent = document.getElementById("loading");
        const stockItemComponent = document.getElementById("stock-item");

        // returns {
        //     ticker: string;
        //     name: string;
        //     is_etf: null | boolean;
        //     exchange: string;
        // }[]
        const getStocks = async () => {
            const storageKey = "stoinks";
            let data = null;

            // Attempt to read data from local cache.
            let rawCache = localStorage.getItem(storageKey);
            if (rawCache !== "") {
                try {
                    const cacheData = JSON.parse(rawCache);
                    if (cacheData && cacheData.expireAt > Date.now()) {
                        data = cacheData.data;
                    }
                } catch (e) {}
            }

            // Query API when empty/corrupt.
            if (data === null) {
                data = await fetch("https://dumbstockapi.com/stock?exchanges=NASDAQ,NYSE").then((r) => r.json());
                localStorage.setItem(storageKey, JSON.stringify({
                    data,
                    expireAt: Date.now() + 1000 * 60 * 60 * 24 * 3,
                }));
            }

            return data;
        }

        const calcPortfolios = (strategy, stocks) => {
            // Can use a ticker more than once.
            const stringBuilder = (target) => {
                const paths = [];
                if (target === "") return paths;
                stocks.forEach((stock) => {
                    const {ticker} = stock;
                    if (target === ticker) {
                        paths.push([stock]);
                        return;
                    }
                    if (target.startsWith(ticker)) {
                        const childPaths = stringBuilder(target.slice(ticker.length));
                        childPaths.forEach((childPath) => paths.push([stock, ...childPath]));
                    }
                    // TODO skip segments that don't match.
                });
                return paths;
            }

            return stringBuilder(strategy);
        }

        const pickPortfolio = (portfolios) => {
            let best = portfolios[0];
            let bestScore = 0;
            for (const portfolio of portfolios) {
                const score = portfolio.reduce((s, stock) => s * stock.ticker.length, 1);
                if (score > bestScore) {
                    best = portfolio;
                    bestScore = score;
                }
            }
            return best;
        }

        const randishAllocation = (tickers) => {
            // Generate random values for each ticker.
            const genRand = rand(tickers.join("/"));
            const values = tickers.map(genRand).map((v) => v + 0.1);

            // Normalize values to sum to 1.
            const total = values.reduce((sum, val) => sum + val, 0);
            const rawPercentages = values.map((v) => v/total);

            // Format as percentages.
            const percentages = rawPercentages.map((p) => Math.round(p * 10000) / 100);

            // Make sure total is always 100.
            const percentagesTotal = percentages.reduce((sum, val) => sum + val, 0);
            const delta = 100 - percentagesTotal;
            if (Math.abs(delta) >= 0.01) {
                console.log(delta);
                percentages[0] = percentages[0] + Math.round(delta * 100) / 100;
            }

            return percentages.map((p) => p.toFixed(2));
        }

        const renderComponent = (element, data) => {
            const template = element.outerHTML;
            let output = "";
            for (const item of data) {
                let templateItem = template;
                for (const [key, value] of Object.entries(item)) {
                    templateItem = templateItem.replace(`$${key}`, String(value));
                }
                output += templateItem;
            }
            container.innerHTML = output;
        };

        const renderLoading = () => {
            renderComponent(loadingComponent, [{}]);
        }

        const renderStocks = (stocks) => {
            const allocations = randishAllocation(stocks.map((s) => s.ticker));
            console.log(allocations.reduce((sum, val) => sum + Number(val), 0));
            stocks.forEach((stock, i) => stock.allocation = allocations[i]);
            renderComponent(stockItemComponent, stocks);
        }

        form.onsubmit = async (e) => {
            e.preventDefault();

            const targetString = query.value.toUpperCase().replace(/[\W_]/g, "");
            if (targetString === "") return;

            renderLoading();
            const [stocks] = await Promise.all([
                getStocks(),
                new Promise((r) => setTimeout(r, 600 + Math.random() * 1000)),
            ]);
            let allPortfolios = calcPortfolios(targetString, stocks);
            if (allPortfolios.length === 0) {
                allPortfolios = calcPortfolios("GME", stocks);
            }
            const bestPortfolio = pickPortfolio(allPortfolios);
            renderStocks(bestPortfolio);
        };

        // Immediately render random stocks for testing purposes.
        if (location.search.includes("test")) {
            (async () => {
                const stocks = await getStocks();
                renderStocks(stocks.filter(() => Math.random() > 0.999));
            })()
        }
    </script>
</body>

</html>